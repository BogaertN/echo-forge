<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoForge - Complete AI Debate & Journaling Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            font-size: 1.8em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }
        
        .logo p {
            font-size: 0.9em;
            color: #666;
            font-style: italic;
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            margin-bottom: 8px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            text-decoration: none;
            color: #555;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .nav-link:hover, .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateX(4px);
        }
        
        .nav-icon {
            margin-right: 12px;
            font-size: 1.2em;
        }
        
        .status-panel {
            margin-top: 30px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .status-panel h4 {
            color: #495057;
            margin-bottom: 8px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .gamification-panel {
            margin-top: 20px;
            padding: 16px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 8px;
        }
        
        .gamification-panel h4 {
            margin-bottom: 12px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 0.8em;
            margin: 2px;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .content-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            margin-bottom: 20px;
        }
        
        .content-section.active {
            display: block;
        }
        
        .section-header {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 2em;
            color: #333;
            margin-bottom: 8px;
        }
        
        .section-subtitle {
            color: #666;
            font-size: 1.1em;
        }
        
        /* Debate Section */
        .debate-input {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .input-group textarea, .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }
        
        .input-group textarea:focus, .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        /* Messages */
        .message-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
        }
        
        .message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 12px;
            animation: fadeInUp 0.5s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.clarifier {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
        }
        
        .message.proponent {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
        }
        
        .message.opponent {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }
        
        .message.synthesis {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        
        .message.synthesizer {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        
        .message.user {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            margin-left: 20px;
        }
        
        .message.error {
            background: #ffebee;
            border: 1px solid #ffcdd2;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .agent-name {
            font-weight: 700;
            font-size: 1.1em;
        }
        
        .timestamp {
            font-size: 0.85em;
            color: #6c757d;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }
        
        /* Journal Section */
        .journal-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
        }
        
        .journal-entry {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.2s ease;
        }
        
        .journal-entry:hover {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .journal-entry h4 {
            color: #495057;
            margin-bottom: 10px;
        }
        
        .journal-meta {
            display: flex;
            justify-content: between;
            align-items: center;
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .journal-tags {
            margin-top: 10px;
        }
        
        .tag {
            display: inline-block;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 6px;
            margin-bottom: 4px;
        }
        
        /* Resonance Map */
        .map-container {
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            min-height: 500px;
            position: relative;
            overflow: hidden;
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        
        .map-controls button {
            margin: 2px;
            padding: 6px 12px;
            font-size: 0.9em;
        }
        
        .node {
            fill: #667eea;
            stroke: #fff;
            stroke-width: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .node:hover {
            fill: #764ba2;
            stroke-width: 3px;
        }
        
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }
        
        .node-label {
            font-family: Arial, sans-serif;
            font-size: 12px;
            fill: #333;
            text-anchor: middle;
            pointer-events: none;
        }
        
        /* Analytics */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 1.1em;
        }
        
        .chart-container {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 300px;
        }
        
        /* Settings */
        .settings-section {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .settings-section h3 {
            color: #495057;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        
        .setting-item {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .setting-label {
            flex: 1;
            font-weight: 500;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: #667eea;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active::after {
            transform: translateX(26px);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 15px;
            }
            
            .nav-menu {
                display: flex;
                overflow-x: auto;
                gap: 10px;
            }
            
            .nav-item {
                margin-bottom: 0;
                min-width: 120px;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .content-section {
                padding: 20px;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        .connection-dot.disconnected {
            background: #dc3545;
            animation: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 15px;
            animation: fadeInUp 0.3s ease;
            border-left: 4px solid #6c757d;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #6c757d;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        /* Export Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            min-width: 400px;
            max-width: 90vw;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.4em;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
        }
        
        .export-options {
            display: grid;
            gap: 10px;
        }
        
        .export-option {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .export-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .export-option h4 {
            margin-bottom: 5px;
            color: #495057;
        }
        
        .export-option p {
            color: #6c757d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="logo">
                <h1>🌀 EchoForge</h1>
                <p>AI Debate & Journaling Platform</p>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-section="debate">
                            <span class="nav-icon">🎯</span>
                            <span>Debate</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="journal">
                            <span class="nav-icon">📝</span>
                            <span>Journal</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="resonance">
                            <span class="nav-icon">🕸️</span>
                            <span>Resonance Map</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="analytics">
                            <span class="nav-icon">📊</span>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="settings">
                            <span class="nav-icon">⚙️</span>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="status-panel">
                <h4>Connection Status</h4>
                <div class="connection-status" id="connectionStatus">
                    <div class="connection-dot disconnected" id="connectionDot"></div>
                    <span id="connectionText">Connecting...</span>
                </div>
                <div class="status-item">
                    <span>Session:</span>
                    <span id="sessionId">Initializing...</span>
                </div>
            </div>
            
            <div class="gamification-panel">
                <h4>🎮 Progress</h4>
                <div class="status-item">
                    <span>Level:</span>
                    <span id="userLevel">1</span>
                </div>
                <div class="status-item">
                    <span>Points:</span>
                    <span id="userPoints">0</span>
                </div>
                <div class="status-item">
                    <span>Streak:</span>
                    <span id="userStreak">0 days</span>
                </div>
                <div id="userBadges">
                    <span class="badge">🌱 Beginner</span>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Debate Section -->
            <section id="section-debate" class="content-section active">
                <div class="section-header">
                    <h2 class="section-title">🎯 Multi-Agent Debate</h2>
                    <p class="section-subtitle">Explore complex topics through structured AI-assisted debate and Socratic questioning</p>
                </div>
                
                <div class="debate-input" id="debateInput">
                    <div class="input-group">
                        <label for="debateQuestion">What would you like to explore through debate?</label>
                        <textarea id="debateQuestion" placeholder="Enter a topic, question, or decision you'd like to think through more deeply...

Examples:
• Should I change careers to follow my passion?
• Is artificial intelligence beneficial or harmful to society?
• What's the most ethical approach to environmental conservation?
• How should I balance work and personal life?"></textarea>
                    </div>
                    <button class="btn" onclick="startDebate()" id="startDebateBtn">🚀 Begin Exploration</button>
                    <button class="btn btn-secondary" onclick="clearDebate()">🔄 Clear & Restart</button>
                    <button class="btn btn-secondary" onclick="exportDebate()">📤 Export Debate</button>
                </div>
                
                <div id="debateMessages" class="message-container"></div>
                
                <div id="debateResponse" class="debate-input hidden">
                    <div class="input-group">
                        <label for="responseText">Your response:</label>
                        <textarea id="responseText" placeholder="Share your thoughts, answer the questions, or provide more context..."></textarea>
                    </div>
                    <button class="btn" onclick="sendResponse()">💬 Send Response</button>
                    <button class="btn btn-secondary" onclick="skipResponse()">⏭️ Skip</button>
                </div>
            </section>
            
            <!-- Journal Section -->
            <section id="section-journal" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">📝 Reflective Journal</h2>
                    <p class="section-subtitle">Document insights, track growth, and build your knowledge base</p>
                </div>
                
                <div class="journal-controls">
                    <div class="search-box">
                        <input type="text" id="journalSearch" placeholder="🔍 Search journal entries..." onkeyup="searchJournal()">
                    </div>
                    <button class="btn" onclick="showNewJournalEntry()">✍️ New Entry</button>
                    <button class="btn btn-secondary" onclick="exportJournal()">📤 Export Journal</button>
                    <select id="journalSort" onchange="sortJournal()">
                        <option value="date-desc">Latest First</option>
                        <option value="date-asc">Oldest First</option>
                        <option value="title">By Title</option>
                        <option value="length">By Length</option>
                    </select>
                </div>
                
                <div id="newJournalEntry" class="debate-input hidden">
                    <div class="input-group">
                        <label for="journalTitle">Entry Title</label>
                        <input type="text" id="journalTitle" placeholder="Give your entry a meaningful title...">
                    </div>
                    <div class="input-group">
                        <label for="journalContent">Content</label>
                        <textarea id="journalContent" placeholder="What insights did you gain? What are you thinking about? Record your thoughts..."></textarea>
                    </div>
                    <div class="input-group">
                        <label for="journalTags">Tags (comma-separated)</label>
                        <input type="text" id="journalTags" placeholder="debate, decision-making, career, philosophy, etc.">
                    </div>
                    <button class="btn" onclick="saveJournalEntry()">💾 Save Entry</button>
                    <button class="btn btn-secondary" onclick="cancelJournalEntry()">❌ Cancel</button>
                </div>
                
                <div id="journalEntries"></div>
            </section>
            
            <!-- Resonance Map Section -->
            <section id="section-resonance" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">🕸️ Resonance Map</h2>
                    <p class="section-subtitle">Visualize connections between ideas, topics, and insights</p>
                </div>
                
                <div class="map-container" id="resonanceMap">
                    <div class="map-controls">
                        <button class="btn" onclick="centerMap()">🎯 Center</button>
                        <button class="btn btn-secondary" onclick="zoomIn()">🔍 Zoom In</button>
                        <button class="btn btn-secondary" onclick="zoomOut()">🔍 Zoom Out</button>
                        <button class="btn btn-secondary" onclick="exportMap()">📤 Export</button>
                    </div>
                    <svg id="mapSvg" width="100%" height="500"></svg>
                </div>
                
                <div class="analytics-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="nodeCount">0</div>
                        <div class="stat-label">Concepts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="connectionCount">0</div>
                        <div class="stat-label">Connections</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="clusterCount">0</div>
                        <div class="stat-label">Clusters</div>
                    </div>
                </div>
            </section>
            
            <!-- Analytics Section -->
            <section id="section-analytics" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">📊 Analytics & Insights</h2>
                    <p class="section-subtitle">Track your progress, patterns, and intellectual growth</p>
                </div>
                
                <div class="analytics-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalDebates">0</div>
                        <div class="stat-label">Total Debates</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalJournalEntries">0</div>
                        <div class="stat-label">Journal Entries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgWordsPerEntry">0</div>
                        <div class="stat-label">Avg Words/Entry</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="currentStreak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>📈 Activity Over Time</h3>
                    <canvas id="activityChart" width="400" height="200"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>🏷️ Most Common Topics</h3>
                    <div id="topicChart"></div>
                </div>
                
                <div class="chart-container">
                    <h3>🎯 Debate Performance</h3>
                    <div id="performanceMetrics"></div>
                </div>
            </section>
            
            <!-- Settings Section -->
            <section id="section-settings" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">⚙️ Settings & Preferences</h2>
                    <p class="section-subtitle">Customize your EchoForge experience</p>
                </div>
                
                <div class="settings-section">
                    <h3>🎯 Debate Settings</h3>
                    <div class="setting-item">
                        <div class="setting-label">
                            <strong>Enable Specialists</strong>
                            <p>Allow domain experts to join debates when relevant</p>
                        </div>
                        <div class="toggle-switch" onclick="toggleSetting('specialists')"></div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <strong>Ghost Loop Detection</strong>
                            <p>Automatically detect and prevent repetitive arguments</p>
                        </div>
                        <div class="toggle-switch active" onclick="toggleSetting('ghostLoop')"></div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <strong>Max Debate Rounds</strong>
                            <p>Limit the number of back-and-forth exchanges</p>
                        </div>
                        <input type="number" value="8" min="3" max="20" style="width: 80px;">
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>🎮 Gamification</h3>
                    <div class="setting-item">
                        <div class="setting-label">
                            <strong>Enable Points & Badges</strong>
                            <p>Track progress with points, levels, and achievements</p>
                        </div>
                        <div class="toggle-switch active" onclick="toggleSetting('gamification')"></div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <strong>Daily Streak Tracking</strong>
                            <p>Monitor consecutive days of engagement</p>
                        </div>
                        <div class="toggle-switch active" onclick="toggleSetting('streaks')"></div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>🔒 Privacy & Data</h3>
                    <div class="setting-item">
                        <div class="setting-label">
                            <strong>Local Processing Only</strong>
                            <p>Keep all AI processing on your device</p>
                        </div>
                        <div class="toggle-switch active" onclick="toggleSetting('localOnly')"></div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <strong>Auto-backup</strong>
                            <p>Automatically backup your data daily</p>
                        </div>
                        <div class="toggle-switch active" onclick="toggleSetting('autoBackup')"></div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <strong>Analytics Collection</strong>
                            <p>Collect usage analytics to improve the experience</p>
                        </div>
                        <div class="toggle-switch" onclick="toggleSetting('analytics')"></div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>📤 Export & Backup</h3>
                    <button class="btn" onclick="exportAllData()">📁 Export All Data</button>
                    <button class="btn btn-secondary" onclick="backupDatabase()">💾 Backup Database</button>
                    <button class="btn btn-danger" onclick="clearAllData()">🗑️ Clear All Data</button>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Export Modal -->
    <div id="exportModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">📤 Export Data</h3>
                <button class="close-btn" onclick="closeModal('exportModal')">&times;</button>
            </div>
            <div class="export-options">
                <div class="export-option" onclick="exportFormat('json')">
                    <h4>📄 JSON Format</h4>
                    <p>Complete data export with all metadata</p>
                </div>
                <div class="export-option" onclick="exportFormat('markdown')">
                    <h4>📝 Markdown Format</h4>
                    <p>Human-readable format for sharing and viewing</p>
                </div>
                <div class="export-option" onclick="exportFormat('pdf')">
                    <h4>📑 PDF Format</h4>
                    <p>Formatted document for printing and archiving</p>
                </div>
                <div class="export-option" onclick="exportFormat('csv')">
                    <h4>📊 CSV Format</h4>
                    <p>Spreadsheet format for analysis</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let websocket = null;
        let sessionId = null;
        let isConnected = false;
        let currentSection = 'debate';
        let journalEntries = [];
        let resonanceData = {nodes: [], links: []};
        let userStats = {
            level: 1,
            points: 0,
            streak: 0,
            badges: ['🌱 Beginner'],
            totalDebates: 0,
            totalJournalEntries: 0
        };
        
        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            initializeWebSocket();
            loadUserData();
            setupEventListeners();
        });
        
        function initializeApp() {
            // Set up navigation
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = e.currentTarget.dataset.section;
                    showSection(section);
                });
            });
            
            // Initialize resonance map
            initializeResonanceMap();
            
            // Load analytics
            updateAnalytics();
        }
        
        function setupEventListeners() {
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case '1':
                            e.preventDefault();
                            showSection('debate');
                            break;
                        case '2':
                            e.preventDefault();
                            showSection('journal');
                            break;
                        case '3':
                            e.preventDefault();
                            showSection('resonance');
                            break;
                        case 'Enter':
                            if (currentSection === 'debate') {
                                e.preventDefault();
                                if (!document.getElementById('debateResponse').classList.contains('hidden')) {
                                    sendResponse();
                                } else {
                                    startDebate();
                                }
                            }
                            break;
                    }
                }
            });
        }
        
        // WebSocket Management
        function initializeWebSocket() {
            sessionId = generateSessionId();
            document.getElementById('sessionId').textContent = sessionId.substring(8, 16);
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${sessionId}`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = () => {
                isConnected = true;
                updateConnectionStatus('Connected', true);
            };
            
            websocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            websocket.onclose = () => {
                isConnected = false;
                updateConnectionStatus('Disconnected', false);
            };
            
            websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus('Error', false);
            };
        }
        
        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }
        
        function updateConnectionStatus(status, connected) {
            document.getElementById('connectionText').textContent = status;
            const dot = document.getElementById('connectionDot');
            
            if (connected) {
                dot.classList.remove('disconnected');
            } else {
                dot.classList.add('disconnected');
            }
        }
        
        // Message Handling - FIXED VERSION
        function handleWebSocketMessage(data) {
            console.log('Received:', data);
            
            switch(data.type) {
                case 'connection_established':
                    updateConnectionStatus('Connected', true);
                    break;
                    
                case 'clarifier_response':
                    addDebateMessage('clarifier', 'StoicClarifier', data.content, data.timestamp);
                    // FIXED: Show response input for clarification phases
                    if (data.show_response_input || data.phase === 'clarification_start' || data.phase === 'clarification_questions') {
                        showDebateResponse();
                    }
                    break;
                    
                case 'question_refined':
                    addDebateMessage('clarifier', 'StoicClarifier', data.content, data.timestamp);
                    hideDebateResponse();
                    break;
                    
                case 'debate_started':
                    addDebateMessage('system', 'System', `🚀 **Debate Started**\n\n**Question:** ${data.question}`, data.timestamp);
                    break;
                    
                case 'agent_response':
                    const agentClass = data.agent.toLowerCase();
                    addDebateMessage(agentClass, data.agent, data.content, data.timestamp);
                    // Add to resonance map
                    addToResonanceMap(data.agent, data.content);
                    break;
                    
                case 'synthesis':
                    addDebateMessage('synthesis', 'Synthesizer', data.content, data.timestamp);
                    break;
                    
                case 'debate_complete':
                    onDebateComplete(data.session_summary);
                    break;
                    
                case 'typing_indicator':
                    if (data.is_typing) {
                        showTypingIndicator(data.agent);
                    } else {
                        hideTypingIndicator();
                    }
                    break;
                    
                case 'error':
                    addDebateMessage('error', 'Error', data.content, data.timestamp);
                    break;
            }
        }
        
        // Navigation
        function showSection(sectionName) {
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === sectionName) {
                    link.classList.add('active');
                }
            });
            
            // Update content
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`section-${sectionName}`).classList.add('active');
            
            currentSection = sectionName;
            
            // Section-specific initialization
            switch(sectionName) {
                case 'resonance':
                    updateResonanceMap();
                    break;
                case 'analytics':
                    updateAnalytics();
                    break;
                case 'journal':
                    loadJournalEntries();
                    break;
            }
        }
        
        // Debate Functions - ENHANCED VERSION
        function startDebate() {
            const question = document.getElementById('debateQuestion').value.trim();
            if (!question) {
                alert('Please enter a question or topic to explore.');
                return;
            }
            
            if (!isConnected) {
                alert('Not connected to server. Please refresh the page.');
                return;
            }
            
            // Clear previous messages
            document.getElementById('debateMessages').innerHTML = '';
            
            addDebateMessage('user', 'You', question);
            
            websocket.send(JSON.stringify({
                type: 'start_debate',
                content: question
            }));
            
            document.getElementById('debateQuestion').value = '';
            
            // Hide debate input until next session
            document.getElementById('debateInput').style.display = 'none';
            
            updateUserStats('debate_started');
        }
        
        function sendResponse() {
            const response = document.getElementById('responseText').value.trim();
            if (!response) {
                alert('Please enter a response.');
                return;
            }
            
            addDebateMessage('user', 'You', response);
            
            websocket.send(JSON.stringify({
                type: 'user_response',
                content: response
            }));
            
            document.getElementById('responseText').value = '';
            hideDebateResponse();
        }
        
        function skipResponse() {
            hideDebateResponse();
            // Send empty response to continue
            websocket.send(JSON.stringify({
                type: 'user_response',
                content: 'Please continue with the debate.'
            }));
        }
        
        function clearDebate() {
            if (confirm('Clear the current debate and start over?')) {
                document.getElementById('debateMessages').innerHTML = '';
                document.getElementById('debateQuestion').value = '';
                document.getElementById('debateInput').style.display = 'block';
                hideDebateResponse();
            }
        }
        
        function addDebateMessage(type, agent, content, timestamp) {
            const container = document.getElementById('debateMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="agent-name">${agent}</span>
                    <span class="timestamp">${time}</span>
                </div>
                <div class="message-content">${formatContent(content)}</div>
            `;
            
            container.appendChild(messageDiv);
            messageDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        function formatContent(content) {
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
        }
        
        function showDebateResponse() {
            console.log('Showing debate response input');
            document.getElementById('debateResponse').classList.remove('hidden');
            document.getElementById('responseText').focus();
        }
        
        function hideDebateResponse() {
            document.getElementById('debateResponse').classList.add('hidden');
            document.getElementById('responseText').value = '';
        }
        
        function showTypingIndicator(agent) {
            hideTypingIndicator();
            const container = document.getElementById('debateMessages');
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
                <strong>${agent} is thinking...</strong>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            container.appendChild(indicator);
            indicator.scrollIntoView({ behavior: 'smooth' });
        }
        
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }
        
        function onDebateComplete(summary) {
            userStats.totalDebates++;
            updateUserStats('debate_completed');
            updateAnalytics();
            
            // Show completion message
            addDebateMessage('system', 'System', `🎉 **Debate Complete!**\n\n**Summary:**\n• Original: ${summary.original_question}\n• Refined: ${summary.clarified_question}\n• Rounds: ${summary.rounds_completed}\n\n*Check your Journal for auto-generated reflection entry!*`);
            
            // Show debate input again
            document.getElementById('debateInput').style.display = 'block';
            
            // Create journal entry from debate
            const journalContent = `Debate completed: ${summary.clarified_question}\n\nKey insights and reflections from this exploration...`;
            createAutoJournalEntry('Debate Reflection', journalContent, 'debate, reflection');
        }
        
        // Journal Functions
        function showNewJournalEntry() {
            document.getElementById('newJournalEntry').classList.remove('hidden');
            document.getElementById('journalTitle').focus();
        }
        
        function cancelJournalEntry() {
            document.getElementById('newJournalEntry').classList.add('hidden');
            document.getElementById('journalTitle').value = '';
            document.getElementById('journalContent').value = '';
            document.getElementById('journalTags').value = '';
        }
        
        function saveJournalEntry() {
            const title = document.getElementById('journalTitle').value.trim();
            const content = document.getElementById('journalContent').value.trim();
            const tags = document.getElementById('journalTags').value.trim();
            
            if (!title || !content) {
                alert('Please enter both a title and content for your journal entry.');
                return;
            }
            
            const entry = {
                id: Date.now(),
                title,
                content,
                tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag),
                timestamp: new Date(),
                wordCount: content.split(' ').length,
                sessionId: sessionId
            };
            
            journalEntries.unshift(entry);
            saveToLocalStorage('journalEntries', journalEntries);
            
            displayJournalEntries();
            cancelJournalEntry();
            
            userStats.totalJournalEntries++;
            updateUserStats('journal_entry');
            updateAnalytics();
            
            // Add to resonance map
            addToResonanceMap('Journal', title, tags);
        }
        
        function createAutoJournalEntry(title, content, tags) {
            const entry = {
                id: Date.now(),
                title: `[Auto] ${title}`,
                content,
                tags: tags.split(',').map(tag => tag.trim()),
                timestamp: new Date(),
                wordCount: content.split(' ').length,
                sessionId: sessionId,
                auto: true
            };
            
            journalEntries.unshift(entry);
            saveToLocalStorage('journalEntries', journalEntries);
            
            if (currentSection === 'journal') {
                displayJournalEntries();
            }
        }
        
        function loadJournalEntries() {
            const saved = loadFromLocalStorage('journalEntries');
            if (saved) {
                journalEntries = saved;
            }
            displayJournalEntries();
        }
        
        function displayJournalEntries() {
            const container = document.getElementById('journalEntries');
            if (journalEntries.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">No journal entries yet. Start by creating your first entry!</p>';
                return;
            }
            
            container.innerHTML = journalEntries.map(entry => `
                <div class="journal-entry">
                    <h4>${entry.title} ${entry.auto ? '<span style="color: #6c757d; font-size: 0.8em;">[Auto]</span>' : ''}</h4>
                    <div class="journal-meta">
                        <span>📅 ${entry.timestamp ? new Date(entry.timestamp).toLocaleDateString() : 'Unknown date'}</span>
                        <span>📝 ${entry.wordCount} words</span>
                        <span>🔗 Session: ${entry.sessionId ? entry.sessionId.substring(8, 16) : 'Unknown'}</span>
                    </div>
                    <div class="message-content">${formatContent(entry.content)}</div>
                    <div class="journal-tags">
                        ${entry.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function searchJournal() {
            const query = document.getElementById('journalSearch').value.toLowerCase();
            const filtered = journalEntries.filter(entry => 
                entry.title.toLowerCase().includes(query) ||
                entry.content.toLowerCase().includes(query) ||
                entry.tags.some(tag => tag.toLowerCase().includes(query))
            );
            
            const container = document.getElementById('journalEntries');
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">No entries found matching your search.</p>';
                return;
            }
            
            // Display filtered results
            const originalEntries = journalEntries;
            journalEntries = filtered;
            displayJournalEntries();
            journalEntries = originalEntries;
        }
        
        function sortJournal() {
            const sortBy = document.getElementById('journalSort').value;
            
            switch(sortBy) {
                case 'date-desc':
                    journalEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    break;
                case 'date-asc':
                    journalEntries.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    break;
                case 'title':
                    journalEntries.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'length':
                    journalEntries.sort((a, b) => b.wordCount - a.wordCount);
                    break;
            }
            
            displayJournalEntries();
        }
        
        // Resonance Map Functions
        function initializeResonanceMap() {
            const svg = d3.select("#mapSvg");
            const width = parseInt(svg.style("width"));
            const height = parseInt(svg.style("height"));
            
            // Create simulation
            window.simulation = d3.forceSimulation()
                .force("link", d3.forceLink().id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2));
            
            // Initialize with welcome node
            addToResonanceMap('Welcome', 'Welcome to EchoForge', ['introduction', 'welcome']);
        }
        
        function addToResonanceMap(source, content, tags = []) {
            const nodeId = `node_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
            
            // Extract key concepts from content
            const concepts = extractConcepts(content);
            
            // Add main node
            resonanceData.nodes.push({
                id: nodeId,
                name: source,
                content: content.substring(0, 100) + '...',
                type: source.toLowerCase(),
                tags: tags,
                concepts: concepts
            });
            
            // Add concept nodes and links
            concepts.forEach(concept => {
                const conceptId = `concept_${concept.toLowerCase().replace(/\s+/g, '_')}`;
                
                // Add concept node if it doesn't exist
                if (!resonanceData.nodes.find(n => n.id === conceptId)) {
                    resonanceData.nodes.push({
                        id: conceptId,
                        name: concept,
                        type: 'concept',
                        size: 1
                    });
                } else {
                    // Increase size if concept already exists
                    const existingNode = resonanceData.nodes.find(n => n.id === conceptId);
                    existingNode.size = (existingNode.size || 1) + 1;
                }
                
                // Add link
                resonanceData.links.push({
                    source: nodeId,
                    target: conceptId,
                    strength: 1
                });
            });
            
            updateResonanceMap();
        }
        
        function extractConcepts(text) {
            // Simple concept extraction
            const words = text.toLowerCase()
                .replace(/[^\w\s]/g, ' ')
                .split(/\s+/)
                .filter(word => word.length > 3);
            
            const conceptWords = words.filter(word => 
                !['this', 'that', 'with', 'have', 'will', 'from', 'they', 'been', 
                 'their', 'said', 'each', 'which', 'what', 'were', 'when', 'where',
                 'more', 'some', 'like', 'time', 'very', 'just', 'first', 'would',
                 'there', 'could', 'other', 'after', 'many', 'than', 'these',
                 'should', 'through', 'being', 'before', 'during', 'about'].includes(word)
            );
            
            // Get unique concepts and their frequency
            const conceptFreq = {};
            conceptWords.forEach(word => {
                conceptFreq[word] = (conceptFreq[word] || 0) + 1;
            });
            
            // Return top concepts
            return Object.keys(conceptFreq)
                .sort((a, b) => conceptFreq[b] - conceptFreq[a])
                .slice(0, 5);
        }
        
        function updateResonanceMap() {
            const svg = d3.select("#mapSvg");
            const width = parseInt(svg.style("width"));
            const height = parseInt(svg.style("height"));
            
            // Clear existing elements
            svg.selectAll("*").remove();
            
            // Create links
            const link = svg.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(resonanceData.links)
                .enter().append("line")
                .attr("class", "link")
                .style("stroke", "#999")
                .style("stroke-opacity", 0.6)
                .style("stroke-width", 2);
            
            // Create nodes
            const node = svg.append("g")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(resonanceData.nodes)
                .enter().append("circle")
                .attr("class", "node")
                .attr("r", d => Math.max(8, (d.size || 1) * 5))
                .style("fill", d => getNodeColor(d.type))
                .style("stroke", "#fff")
                .style("stroke-width", 2)
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));
            
            // Add labels
            const label = svg.append("g")
                .attr("class", "labels")
                .selectAll("text")
                .data(resonanceData.nodes)
                .enter().append("text")
                .attr("class", "node-label")
                .text(d => d.name)
                .style("font-size", "12px")
                .style("text-anchor", "middle")
                .style("fill", "#333");
            
            // Add tooltips
            node.append("title")
                .text(d => `${d.name}\nType: ${d.type}\nContent: ${d.content || 'No content'}`);
            
            // Update simulation
            window.simulation.nodes(resonanceData.nodes);
            window.simulation.force("link").links(resonanceData.links);
            
            window.simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                
                node
                    .attr("cx", d => Math.max(20, Math.min(width - 20, d.x)))
                    .attr("cy", d => Math.max(20, Math.min(height - 20, d.y)));
                
                label
                    .attr("x", d => Math.max(20, Math.min(width - 20, d.x)))
                    .attr("y", d => Math.max(20, Math.min(height - 20, d.y - 15)));
            });
            
            window.simulation.restart();
            
            // Update stats
            document.getElementById('nodeCount').textContent = resonanceData.nodes.length;
            document.getElementById('connectionCount').textContent = resonanceData.links.length;
            document.getElementById('clusterCount').textContent = Math.ceil(resonanceData.nodes.length / 5);
        }
        
        function getNodeColor(type) {
            const colors = {
                'clarifier': '#ff9800',
                'proponent': '#4caf50',
                'opponent': '#f44336',
                'synthesis': '#9c27b0',
                'journal': '#2196f3',
                'concept': '#667eea',
                'default': '#6c757d'
            };
            return colors[type] || colors.default;
        }
        
        function dragstarted(event, d) {
            if (!event.active) window.simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) window.simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        
        function centerMap() {
            const svg = d3.select("#mapSvg");
            const width = parseInt(svg.style("width"));
            const height = parseInt(svg.style("height"));
            
            window.simulation.force("center", d3.forceCenter(width / 2, height / 2));
            window.simulation.restart();
        }
        
        function zoomIn() {
            console.log('Zoom in functionality');
        }
        
        function zoomOut() {
            console.log('Zoom out functionality');
        }
        
        // Analytics Functions
        function updateAnalytics() {
            // Update stat cards
            document.getElementById('totalDebates').textContent = userStats.totalDebates;
            document.getElementById('totalJournalEntries').textContent = userStats.totalJournalEntries;
            document.getElementById('currentStreak').textContent = userStats.streak;
            
            const avgWords = journalEntries.length > 0 
                ? Math.round(journalEntries.reduce((sum, entry) => sum + entry.wordCount, 0) / journalEntries.length)
                : 0;
            document.getElementById('avgWordsPerEntry').textContent = avgWords;
            
            // Update charts
            updateActivityChart();
            updateTopicChart();
            updatePerformanceMetrics();
        }
        
        function updateActivityChart() {
            const canvas = document.getElementById('activityChart');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#667eea';
                ctx.fillRect(50, 50, 100, 100);
                ctx.fillStyle = '#764ba2';
                ctx.fillRect(200, 80, 100, 70);
                ctx.fillText('Activity visualization coming soon...', 50, 180);
            }
        }
        
        function updateTopicChart() {
            const allTags = journalEntries.flatMap(entry => entry.tags);
            const tagCounts = {};
            allTags.forEach(tag => {
                tagCounts[tag] = (tagCounts[tag] || 0) + 1;
            });
            
            const topTags = Object.entries(tagCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            const container = document.getElementById('topicChart');
            container.innerHTML = topTags.length > 0 
                ? topTags.map(([tag, count]) => 
                    `<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>${tag}</span>
                        <span>${count}</span>
                    </div>`
                ).join('')
                : '<p style="color: #6c757d;">No topics yet. Start journaling!</p>';
        }
        
        function updatePerformanceMetrics() {
            const container = document.getElementById('performanceMetrics');
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #28a745;">${userStats.totalDebates}</div>
                        <div style="color: #6c757d;">Debates Completed</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #17a2b8;">${userStats.streak}</div>
                        <div style="color: #6c757d;">Current Streak</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #ffc107;">${userStats.level}</div>
                        <div style="color: #6c757d;">Current Level</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;">${userStats.points}</div>
                        <div style="color: #6c757d;">Total Points</div>
                    </div>
                </div>
            `;
        }
        
        // User Stats & Gamification
        function updateUserStats(action) {
            switch(action) {
                case 'debate_started':
                    userStats.points += 10;
                    break;
                case 'debate_completed':
                    userStats.points += 50;
                    userStats.streak = updateStreak();
                    checkLevelUp();
                    break;
                case 'journal_entry':
                    userStats.points += 20;
                    userStats.streak = updateStreak();
                    checkLevelUp();
                    break;
            }
            
            saveToLocalStorage('userStats', userStats);
            updateGamificationPanel();
        }
        
        function updateStreak() {
            return userStats.streak + 1; // Simplified
        }
        
        function checkLevelUp() {
            const pointsForNextLevel = userStats.level * 100;
            if (userStats.points >= pointsForNextLevel) {
                userStats.level++;
                userStats.badges.push(`🌟 Level ${userStats.level}`);
                showAchievementNotification(`Level Up! You're now level ${userStats.level}!`);
            }
        }
        
        function updateGamificationPanel() {
            document.getElementById('userLevel').textContent = userStats.level;
            document.getElementById('userPoints').textContent = userStats.points;
            document.getElementById('userStreak').textContent = `${userStats.streak} days`;
            
            const badgesContainer = document.getElementById('userBadges');
            badgesContainer.innerHTML = userStats.badges
                .slice(-3)
                .map(badge => `<span class="badge">${badge}</span>`)
                .join('');
        }
        
        function showAchievementNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
                animation: slideInRight 0.5s ease;
            `;
            notification.textContent = `🎉 ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Settings Functions
        function toggleSetting(settingName) {
            const toggle = event.target;
            toggle.classList.toggle('active');
            
            const settings = loadFromLocalStorage('settings') || {};
            settings[settingName] = toggle.classList.contains('active');
            saveToLocalStorage('settings', settings);
        }
        
        // Export Functions
        function exportDebate() {
            showModal('exportModal');
        }
        
        function exportJournal() {
            showModal('exportModal');
        }
        
        function exportMap() {
            showModal('exportModal');
        }
        
        function exportAllData() {
            showModal('exportModal');
        }
        
        function exportFormat(format) {
            const data = {
                journalEntries,
                userStats,
                resonanceData,
                settings: loadFromLocalStorage('settings'),
                exportDate: new Date().toISOString()
            };
            
            let content, filename;
            
            switch(format) {
                case 'json':
                    content = JSON.stringify(data, null, 2);
                    filename = `echoforge-export-${Date.now()}.json`;
                    break;
                case 'markdown':
                    content = generateMarkdownExport(data);
                    filename = `echoforge-export-${Date.now()}.md`;
                    break;
                case 'csv':
                    content = generateCSVExport(data);
                    filename = `echoforge-journal-${Date.now()}.csv`;
                    break;
                case 'pdf':
                    alert('PDF export functionality coming soon!');
                    closeModal('exportModal');
                    return;
            }
            
            downloadFile(content, filename);
            closeModal('exportModal');
        }
        
        function generateMarkdownExport(data) {
            let markdown = `# EchoForge Export\n\nExported on: ${new Date().toLocaleString()}\n\n`;
            
            markdown += `## User Statistics\n`;
            markdown += `- Level: ${data.userStats.level}\n`;
            markdown += `- Points: ${data.userStats.points}\n`;
            markdown += `- Total Debates: ${data.userStats.totalDebates}\n`;
            markdown += `- Journal Entries: ${data.userStats.totalJournalEntries}\n\n`;
            
            markdown += `## Journal Entries\n\n`;
            data.journalEntries.forEach((entry) => {
                markdown += `### ${entry.title}\n`;
                markdown += `**Date:** ${new Date(entry.timestamp).toLocaleString()}\n`;
                markdown += `**Tags:** ${entry.tags.join(', ')}\n\n`;
                markdown += `${entry.content}\n\n---\n\n`;
            });
            
            return markdown;
        }
        
        function generateCSVExport(data) {
            const headers = ['Title', 'Date', 'Content', 'Tags', 'Word Count'];
            const rows = data.journalEntries.map(entry => [
                entry.title,
                new Date(entry.timestamp).toISOString(),
                entry.content.replace(/"/g, '""'),
                entry.tags.join(';'),
                entry.wordCount
            ]);
            
            return [headers, ...rows]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');
        }
        
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function backupDatabase() {
            const data = {
                journalEntries,
                userStats,
                resonanceData,
                settings: loadFromLocalStorage('settings'),
                backupDate: new Date().toISOString()
            };
            
            downloadFile(JSON.stringify(data, null, 2), `echoforge-backup-${Date.now()}.json`);
            showAchievementNotification('Database backup completed!');
        }
        
        function clearAllData() {
            if (confirm('⚠️ Delete ALL data? This cannot be undone!')) {
                localStorage.clear();
                location.reload();
            }
        }
        
        // Modal Functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        // Utility Functions
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }
        
        function loadFromLocalStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
                return null;
            }
        }
        
        function loadUserData() {
            const savedStats = loadFromLocalStorage('userStats');
            if (savedStats) {
                userStats = { ...userStats, ...savedStats };
            }
            
            const savedEntries = loadFromLocalStorage('journalEntries');
            if (savedEntries) {
                journalEntries = savedEntries;
            }
            
            updateGamificationPanel();
            updateAnalytics();
        }
        
        // Save data periodically
        setInterval(() => {
            saveToLocalStorage('userStats', userStats);
            saveToLocalStorage('journalEntries', journalEntries);
            saveToLocalStorage('resonanceData', resonanceData);
        }, 30000);
        
    </script>
</body>
</html>
